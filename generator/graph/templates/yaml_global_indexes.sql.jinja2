-- yaml_global_indexes.sql.jinja2
-- Strategic indexes for {{ project_name }} graph database
-- Generated from YAML configuration

{% for rel_type, info in relationship_types.items() %}
-- Indexes for {{ rel_type }} relationships
CREATE INDEX IF NOT EXISTS idx_{{ rel_type|lower }}_source 
ON {{ project_name }}."{{ rel_type }}" (start_id);

CREATE INDEX IF NOT EXISTS idx_{{ rel_type|lower }}_target 
ON {{ project_name }}."{{ rel_type }}" (end_id);

{% if info.has_year %}
CREATE INDEX IF NOT EXISTS idx_{{ rel_type|lower }}_year 
ON {{ project_name }}."{{ rel_type }}" USING btree (agtype_access_operator(VARIADIC ARRAY[properties, '"year"'::agtype]));
{% endif %}

CREATE INDEX IF NOT EXISTS idx_{{ rel_type|lower }}_source_dataset 
ON {{ project_name }}."{{ rel_type }}" USING btree (agtype_access_operator(VARIADIC ARRAY[properties, '"source_dataset"'::agtype]));

{% if rel_type == 'HAS_PRICE' and info.has_months %}
-- Additional indexes for price queries
CREATE INDEX IF NOT EXISTS idx_{{ rel_type|lower }}_months 
ON {{ project_name }}."{{ rel_type }}" USING btree (agtype_access_operator(VARIADIC ARRAY[properties, '"months_code"'::agtype]));
{% endif %}

{% endfor %}

-- Compound indexes for common query patterns
{% for rel_type, info in relationship_types.items() %}
{% if info.has_year %}
CREATE INDEX IF NOT EXISTS idx_{{ rel_type|lower }}_year_source_compound 
ON {{ project_name }}."{{ rel_type }}" USING btree (
    agtype_access_operator(VARIADIC ARRAY[properties, '"year"'::agtype]),
    agtype_access_operator(VARIADIC ARRAY[properties, '"source_dataset"'::agtype]),
    start_id,
    end_id
);
{% endif %}
{% endfor %}

-- Alternative: GIN indexes for properties (choose one approach)
-- These are more flexible but may be less performant for specific property lookups
{% for rel_type, info in relationship_types.items() %}
-- CREATE INDEX IF NOT EXISTS idx_{{ rel_type|lower }}_properties_gin 
-- ON {{ project_name }}."{{ rel_type }}" USING gin (properties);
{% endfor %}